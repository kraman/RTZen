<project name="Zen Source Packages" default="all" basedir="./..">
   <property file="zen-build-bootstrap.properties"/>
   <property file="zen-build.properties"/>

    <taskdef resource="org/aspectj/tools/ant/taskdefs/aspectjTaskdefs.properties"/>
    <taskdef name="jRate" classname="edu.uci.ece.doc.tools.ant.taskdefs.compilers.jRate" classpath="${zen.classpath}" onError="ignore"/>

    <import file="property_processor.xml"/>

    <patternset id="sources" >
        <!--*** OMG Sources ***-->
            <include name="src/edu/uci/ece/zen/utils/Logger.java"/>
            <include name="src/edu/uci/ece/zen/utils/**"/>
            <include name="omg-01-02-01/org/omg/CORBA/**"/>
            <include name="omg-01-02-01/org/omg/CORBA_2_3/**"/>
            <include name="generated/org/omg/Dynamic/**/" if="zen.aspects.pi"/>
            <include name="generated/org/omg/IOP/**/"/>
            <include name="generated/org/omg/IIOP/**/"/>
            <include name="omg-01-02-01/org/omg/IOP_N/**/" if="zen.aspects.pi"/>
            <include name="omg-01-02-01/org/omg/RTCORBA/**" if="zen.rtcorba"/>
            <include name="omg-01-02-01/org/omg/RTPortableServer/**"/>
            <include name="omg-01-02-01/org/omg/PortableServer/**"/>

            <include name="generated/org/omg/CORBA/**"/>
            <include name="generated/org/omg/RTCORBA/**"/>
            <include name="omg-01-02-01/org/omg/RTCORBA/PriorityMapping.java"/>
            <include name="generated/org/omg/CORBA_2_3/**"/>
            <include name="generated/org/omg/IOP/**"/>
            <include name="generated/org/omg/GIOP/**"/>
            <include name="generated/org/omg/PortableServer/**"/> 
            <include name="generated/org/omg/Messaging/**"/> 
            <include name="generated/org/omg/TimeBase/**"/> 
        
        <!--*** Doug Lea's Concurrent Package ***-->
            <include name="src/edu/oswego/cs/dl/util/concurrent/**"/>

        <!--*** Zen core packages ***-->
            <include name="src/edu/uci/ece/zen/utils/**"/>
            <include name="src/edu/uci/ece/zen/orb/any/**"/>
            <!--<include name="src/edu/uci/ece/zen/orb/dynany/**"/> doesn't compile-->
            <include name="src/edu/uci/ece/zen/orb/transport/**"/>
            <include name="src/edu/uci/ece/zen/orb/**.java"/>
            <include name="src/edu/uci/ece/zen/orb/policies/**.java"/>
            <include name="src/edu/uci/ece/zen/orb/giop/GIOPMessage.java"/>
            <include name="src/edu/uci/ece/zen/orb/giop/SendRunnable.java"/>
            <include name="src/edu/uci/ece/zen/orb/giop/GIOPMessageFactory.java"/>
            <include name="src/edu/uci/ece/zen/orb/giop/MSGRunnable.java"/>
            <include name="src/edu/uci/ece/zen/orb/giop/GIOPHeaderInfo.java"/>
            <include name="src/edu/uci/ece/zen/orb/giop/v1_0/**.java"/>
            <include name="src/edu/uci/ece/zen/orb/giop/v1_1/**.java"/>
            <include name="src/edu/uci/ece/zen/orb/giop/v1_2/**.java"/>
            <include name="src/edu/uci/ece/zen/orb/giop/IOP/**.java"/>
            <include name="src/edu/uci/ece/zen/orb/giop/type/**.java"/>
            <exclude name="src/edu/uci/ece/zen/orb/ServerRequest.java"/>
            <exclude name="src/edu/uci/ece/zen/orb/ExceptionHandler.java"/>
            <exclude name="src/edu/uci/ece/zen/orb/ExceptionHandler.java"/>
            <exclude name="src/edu/uci/ece/zen/orb/TracerAspect.java"/>
            <exclude name="src/edu/uci/ece/zen/orb/TypeCodeAspect.java"/>

            <include name="src/edu/uci/ece/zen/poa/**"/>
            <exclude name="src/edu/uci/ece/zen/orb/giop/v1_1/**"/>
            <exclude name="src/edu/uci/ece/zen/orb/giop/v1_2/**"/>

            <exclude name="src/edu/uci/ece/zen/orb/resolvers/**"/>

            <exclude name="src/edu/uci/ece/zen/poa/mechanism/ServantLocatorStrategy.java"/>

        <!--*** classes that jRate cant compile ***-->
            <exclude name="src/edu/oswego/cs/dl/util/concurrent/VetoableChangeMulticaster.java"/>
            <exclude name="src/edu/oswego/cs/dl/util/concurrent/PropertyChangeMulticaster.java"/>
            <exclude name="src/edu/oswego/cs/dl/util/concurrent/CopyOnWriteArraySet.java"/>
            <exclude name="src/edu/oswego/cs/dl/util/concurrent/ObservableSync.java"/>
            <exclude name="src/edu/oswego/cs/dl/util/concurrent/FJTask**"/>
            <exclude name="src/edu/oswego/cs/dl/util/concurrent/ObservableSync.java"/>
            <include name="src/edu/uci/ece/zen/utils/Logger.java"/>
    </patternset>

    <target name="all" depends="idl, compile, lib, jRate, naming_service"/>

    <target name="idl">
        <echo message="Compiling IDL files"/>
        <ant antfile="${zen.srcdir}/idl/build.xml"/>
    </target>

    <target name="compile">
        <echo message="Compiling OMG and Zen sources"/>
      
        <javac  
            destdir="${zen.classdir}"          
            srcdir="${zen.srcdir}"
            failonerror = "true"
            fork = "true"
            target="1.1"
			debug="true"
            bootclasspath="${zen.rtbootclasspath}"
            includeJavaRuntime="yes"
            >
            
            <patternset refid="sources"/>
            <patternset>
                <include name="src/edu/uci/ece/doc/tools/ant/taskdefs/compilers/jRate.java" if="compiler_jRate"/>
                <include name="src/javax/**" if="compiler_jdk"/>
                <!--classpath="${basedir}/../fake_rtjava/lib/foundation.jar"
                -->
            </patternset>
            
            <classpath>
                <pathelement location="${zen.classpath}"/> 
            </classpath>
        </javac>
    </target>

    <target name="jRate" if="compiler_jRate">
        <jRate
            optimizeLevel="2"
            libDirs="${zen.jRateLibDir}"
            sharedLib="true"
            destdir="${zen.libdir}"
            out="${zen.libdir}/libZen.so"
            bootclasspath="${zen.rtbootclasspath}"
            classpath="${jRate_classpath}:${zen.classdir}"
            debug="true"
            >
            <fileset dir="${zen.srcdir}">
               <patternset refid="sources"/>
            </fileset>
        </jRate>
    </target>
    
    <target name="naming_service" if="zen.naming">
        <ant antfile="${zen.srcdir}/src/edu/uci/ece/zen/services/naming/build.xml"/>
    </target>

    <target name="lib">
        <jar 
        jarfile="${zen.libdir}/RTZen.jar" 
        basedir="${zen.classdir}" 
        includes="org/omg/**,edu/**"
        />
        <jar 
        jarfile="${zen.libdir}/realtime.jar" 
        basedir="${zen.classdir}" 
        includes="javax/realtime/**"
        />
    </target>

    <target name="clean">
        <echo message="Removing generated directory all its contents"/>
        <delete failonerror="false" dir="${zen.srcdir}/generated"/>
    </target>
</project>
